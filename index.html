<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" type="image/png" href="icons/favicon.png">
  <link rel="manifest" href="./manifest.webmanifest?v=0.84" />
  <link rel="stylesheet" href="./styles.css?v=0.84" />
  <title>자리배치 PWA</title>
</head>
<body>
  <header class="header">
    <div class="headerTop">
      <div>
        <h1>자리배치 PWA <span style="opacity:.65;font-weight:900">v0.84</span></h1>
        <p class="sub">책상 배열 → 학생 입력 → 자동 배치</p>
      </div>
      <div class="status">
        <div class="pill">Service Worker: <b id="swStatus">확인 중…</b></div>
      </div>
    </div>
  </header>

  <main class="layout">
    <section class="card stageWrap">
      <div class="menuBar">
        <div class="menuLeft menuCol">
          <div class="menuRow menuRowMain">
            <button id="openLayoutBtn" class="required">책상 배열</button>
            <button id="openStudentsBtn" class="required">학생 입력</button>
            <button id="autoFillBtn" class="required">자동 배치★</button>
          </div>

          <div class="menuRow menuRowModes">
            <button id="modeGenderBtn" class="ghost"><span class="btnEmoji" aria-hidden="true">👦👧</span><span class="btnLabel">성별 지정</span></button>
            <button id="modePinBtn" class="ghost"><span class="btnEmoji" aria-hidden="true">📌</span><span class="btnLabel">고정 좌석</span></button>
            <button id="openOptionsBtn" class="ghost"><span class="btnEmoji" aria-hidden="true">⚙️</span><span class="btnLabel">세부 옵션</span></button>
            <button id="clearBtn" class="ghost"><span class="btnLabel">초기화</span></button>
          </div>
        </div>

        <div class="menuRight menuCol">
          <div class="menuRow menuRowRight menuRowActions">
            <button id="openSaveBtn" class="smallBtn">저장/불러오기</button>
            <button id="downloadPngBtn" class="smallBtn">이미지 다운로드</button>
            <button id="printBtn" class="smallBtn">인쇄</button>
          </div>

          <div class="menuRow menuRowRight menuRowToggles">
            <div id="displayPanelHost" class="displayHost">
              <div class="displayPanel">
                <label class="toggle"><input id="showSeatNo" type="checkbox" checked> 좌석 번호 표시</label>
                <label class="toggle"><input id="showGroups" type="checkbox"> 모둠 번호 표시</label>
                <label class="toggle"><input id="showGender" type="checkbox"> 성별 표시</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="modeBanner" class="modeBanner"></div>

      <div id="hintBar" class="hintBar">
        <div class="hintText">
          <span class="hintIcon" aria-hidden="true">💡</span>
          <span>책상을 클릭/드래그하면 자리 이동·교체·삭제가 가능해요.</span>
        </div>
        <button id="hintCloseBtn" class="hintCloseBtn" title="닫기" aria-label="닫기">×</button>
      </div>

      <div id="violationsBar" class="violationsBar"></div>

      <div id="stage" class="stage">
        <div class="boardBar">
          <div class="boardSpacer"></div>
          <div class="boardBig"><div class="boardBigLabel">칠판</div></div>
          <div class="boardRight">
            <button id="toggleOrientationBtn" class="boardBtn multiline">교사 시점으로<br>바꾸기</button>
          </div>
        </div>

        <div id="grid" class="grid" aria-label="자리 배치"></div>
      </div>

      <div id="log" class="log"></div>
      <canvas id="exportCanvas" class="hiddenCanvas"></canvas>

      <!-- 내부 렌더 옵션(숨김) -->
      <select id="seatType" class="hidden">
        <option value="single" selected>single</option>
      </select>
    </section>
  </main>

  <!-- ===================== Modals ===================== -->

  <!-- 책상 배열 -->
  <div id="layoutModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">책상 배열</div>
        <button class="xBtn" data-close="layoutModal" aria-label="닫기">×</button>
      </div>
      <div class="modalBody">
        <div class="modalHint">
          <div class="modalHintPrimary"><span class="hintIcon" aria-hidden="true">💡</span>기본 책상 배열을 선택해 주세요.</div>
          <div class="modalHintSub">(기본 배열 선택 후 메인창에서 개별 책상 이동 및 삭제가 가능합니다.)</div>
        </div>

        <div class="row">
          <div class="field">
            <label class="stepLabel">&nbsp;▸ 책상 형태</label>
            <select id="layoutKind">
              <option value="single">1인 책상</option>
              <option value="pair">2인 책상(짝)</option>
              <option value="group">모둠 책상</option>
            </select>
          </div>

          <div class="field">
            <label>미리보기(계산된 격자)</label>
            <div id="layoutPreview" class="previewBox"></div>
          </div>
        </div>

        <hr class="sep" />

        <div id="accSingle" class="acc">
          <div class="accHead accHeadSmall">&nbsp;▸ 1인 책상 옵션</div>
          <div class="accBody">
            <div class="row">
              <div class="field">
                <label>열(가로)</label>
                <select id="colsSingle">
                  <option>1</option><option>2</option><option>3</option><option selected>5</option><option>6</option><option>7</option><option>8</option>
                </select>
              </div>
              <div class="field">
                <label>행(세로)</label>
                <select id="rowsSingle">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6" selected>6</option>
            </select>
              </div>
            </div>
          </div>
        </div>

        <div id="accPair" class="acc hidden">
          <div class="accHead">&nbsp;▸ 2인 책상(짝) 옵션</div>
          <div class="accBody">
            <div class="row">
              <div class="field">
                <label>열(짝열, 최대 4)</label>
                <select id="pairCols">
                  <option>1</option><option selected>2</option><option>3</option><option>4</option>
                </select>
              </div>
              <div class="field">
                <label>행(세로)</label>
                <select id="rowsPair">

                <option>1</option>

                <option>2</option>

                <option>3</option>

                <option>4</option>

                <option>5</option>

                <option selected>6</option>

                </select>
              </div>
            </div>
          </div>
        </div>

        <div id="accGroup" class="acc hidden">
          <div class="accHead">&nbsp;▸ 모둠 책상 옵션</div>
          <div class="accBody">
            <div class="row">
              <div class="field">
                <label>모둠 인원</label>
                <select id="groupSize">
                  <option selected>4</option>
                  <option>5</option>
                  <option>6</option>
                </select>
              </div>
              <div class="field">
                <label>모둠 개수</label>
                <select id="groupCount">
                  <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option><option>6</option>
                </select>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="modalFoot">
        <button id="applyLayoutBtn">적용</button>
        <button class="ghost" data-close="layoutModal">닫기</button>
      </div>
    </div>
  </div>

  <!-- 학생 입력 -->
  <div id="studentsModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">학생 입력</div>
        <button class="xBtn" data-close="studentsModal" aria-label="닫기">×</button>
      </div>
      <div class="modalBody">
        <div class="modalHint">
          <div class="modalHintPrimary"><span class="hintIcon" aria-hidden="true">💡</span>학생 명단을 입력하세요.</div>
          <div class="modalHintSub">성별 / 학습 수준을 입력하면 <span class="hlGender">성별에 따른 자리 배치 기능</span>, <span class="hlLevel">모둠별 수준 분산 기능</span>을 사용하실 수 있어요.</div>
        </div>

        <div class="studentsUi">
  <div class="studentsTableWrap">
    <table id="studentsTable">
      <thead>
        <tr>
          <th class="colNo">번호</th>
          <th class="colName">이름(필수)</th>
          <th class="colGender">
            <label class="thToggle tip" title="성별을 입력하면 성별에 따라 자리를 배치할 수 있어요.">
              <input id="useGenderToggle" type="checkbox" />
              성별(선택)
            </label>
          </th>
          <th class="colLevel">
            <label class="thToggle tip" title="학습 수준을 입력하면 모둠별로 수준을 분산하여 자리를 배치할 수 있어요.">
              <input id="useLevelToggle" type="checkbox" />
              학습 수준(선택)
            </label>
          </th>
          <th class="colDel"></th>
        </tr>
      </thead>
      <tbody id="studentsTbody"></tbody>
    </table>
  </div>

  <!-- 기존 로직 호환용(숨김) -->
  <textarea id="studentsInput" class="srOnly" aria-hidden="true"></textarea>
</div>
      </div>
      <div class="modalFoot modalFootBetween">
        <div class="studentsFootLeft">
          <button id="addStudentRowBtn" class="ghost">행 추가</button>
          <button id="clearStudentsBtn" class="ghost danger">전부 삭제</button>
        </div>
        <div class="modalFootRight">
          <button id="applyStudentsBtn">저장</button>
          <button id="closeStudentsBtn" class="ghost" data-close="studentsModal">닫기</button>
        </div>
      </div>

</div>
  </div>

  <!-- 세부 옵션 -->
  <div id="optionsModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">세부 옵션</div>
        <button class="xBtn" data-close="optionsModal" aria-label="닫기">×</button>
      </div>
      <div class="modalBody">
        <div class="sectionBlock">
          <div class="sectionHead">
            <label class="sectionHeadToggle">
              <input id="useForbidden" type="checkbox" checked />
              <span class="sectionTitle">금지쌍</span>
              <span class="sectionHeadDescInline">-지정한 학생들을 서로 인접하지 않게 배치해요</span>
            </label>
          </div>
          <!-- 금지쌍 입력(그룹 UI) -->
          <div id="forbiddenGroupsUI" class="forbiddenGroupsUI">
            <div id="forbiddenGroupsContainer" class="forbiddenGroupsContainer"></div>
            <div class="row forbiddenGroupRow" style="margin-top:8px; display:flex; align-items:center; justify-content:flex-start; gap:10px;">
              <button id="addForbiddenGroupBtn" class="ghost smallBtn" type="button">그룹 추가</button>
              <label class="toggle" style="margin:0; white-space:nowrap;"><input id="includeDiagonal" type="checkbox" /> 대각선도 인접으로 판단</label>
            </div>
          </div>

          <!-- 기존 로직 호환용(숨김): 한 줄에 쉼표로 구분된 이름들 -->
          <textarea id="forbiddenInput" class="srOnly" aria-hidden="true" placeholder="예)
이수지, 정이랑
유재석, 하하, 유재석, 박명수"></textarea>
          </div>

        <hr class="sep" />

        <div class="sectionBlock">
          <div class="sectionHead">
            <label class="sectionHeadToggle">
              <input id="balanceLevels" type="checkbox" />
              <span class="sectionTitle">모둠별 수준 분산</span>
              <span class="sectionHeadDescInline">- 모둠별 학습수준(상/중/하)이 고르게 섞이도록 배치해요</span>
            </label>
          </div>
          <div class="row">
            <div class="field">
              <label>모둠 인원</label>
              <select id="groupMode">
                <option value="none" selected>사용 안 함</option>
                <option value="4">4명씩</option>
                <option value="5">5명씩</option>
                <option value="6">6명씩</option>
              </select>
            </div>
          </div>
        </div>

        <hr class="sep" />

        <div class="sectionBlock">
          <div class="sectionHead">
            <label class="sectionHeadToggle">
              <input id="useRotation" type="checkbox" checked />
              <span class="sectionTitle">맨 앞줄/맨 뒷줄 로테이션</span>
              <span class="sectionHeadDescInline">-배치도 저장 시 맨 앞/ 맨 뒤 학생들을 기록하여 매월 골고루 배치해요</span>
            </label>
          </div>
          <div class="row">
            <label class="toggle"><input id="rotateFront" type="checkbox" checked /> 맨 앞줄 로테이션 기록</label>
            <label class="toggle"><input id="rotateBack" type="checkbox" checked /> 맨 뒷줄 로테이션 기록</label>
            <button id="resetHistoryBtn" class="ghost smallBtn">기록 초기화</button>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button id="applyOptionsBtn">적용</button>
        <button class="ghost" data-close="optionsModal">닫기</button>
      </div>
    </div>
  </div>

<!-- 저장/불러오기 -->
  <div id="saveModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">저장/불러오기</div>
        <button class="xBtn" data-close="saveModal" aria-label="닫기">×</button>
      </div>
      <div class="modalBody">
        <div class="row savePanel">
          <div class="field slotListField">
            <label>저장된 배치도 목록</label>
            <div class="slotListWrap" aria-label="저장된 배치도 목록">
              <div id="slotList" class="slotList" role="listbox" aria-label="저장된 배치도 목록"></div>
              <div id="slotEmpty" class="slotEmpty">(저장 목록 없음)</div>
            </div>
            <select id="slotSelect" class="hiddenSelect" aria-hidden="true" tabindex="-1"></select>
          </div>

          <div class="slotActions" aria-label="저장된 배치도 작업">
            <button id="newSlotBtn" class="ghost">💾 새로 저장</button>
            <button id="saveBtn">📝 저장(덮어쓰기)</button>
            <button id="loadBtn" class="ghost">📂 불러오기</button>
            <button id="deleteSlotBtn" class="ghost">🗑️ 삭제</button>
            <button id="shareBtn" class="ghost">🔗 공유</button>
          </div>
        </div>

        <div id="shareBox" class="shareBox hidden" aria-live="polite">
          <div class="shareHead">
            <div class="shareTitle">공유 링크 <span class="shareDesc">현재 배치도를 다른 PC나 모바일로 공유할 수 있는 링크를 제공합니다.<br><span class="share-note">※ 이 링크는 생성 당시의 배치도 상태만 담고 있어요.<br>이후에 수정한 내용은 자동으로 반영되지 않으므로, 수정 후에는 다시 공유 버튼을 눌러 새 링크를 만들어 주세요.</span></span></div>
            <button id="shareCloseBtn" class="ghost smallInline">닫기</button>
          </div>

          <label class="toggle warnToggle"><input id="shareWarnToggle" type="checkbox" checked> 경고 문구 표시</label>
          <div id="shareWarnText" class="shareWarnText">
            ⚠️ 이 링크에는 현재 배치도의 정보(실명/개인정보) 등이 포함되어 있으니 공유에 주의하세요. 특히 공개 게시(카페/단톡방/블로그 등)는 삼가주시길 바랍니다.
          </div>

          <div class="row">
            <button id="shareCopyBtn" class="ghost" disabled>링크 복사</button>
          </div>

          <div class="field">
            <label>공유 링크</label>
            <input id="shareLinkInput" type="text" readonly placeholder="공유 버튼을 눌러 링크를 생성하세요." />
          </div>
        </div>

      </div><div class="modalFoot">
        <button class="ghost" data-close="saveModal">닫기</button>
      </div>
    </div>
  </div>


  <!-- 공유 링크로 들어왔을 때: 자동 적용하지 않고 미리보기 → 적용 -->
  <div id="incomingShareModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">공유 배치도 미리보기</div>
        <button class="xBtn" data-close="incomingShareModal" aria-label="닫기">×</button>
      </div>
      <div class="modalBody">
        <label class="toggle warnToggle"><input id="incomingWarnToggle" type="checkbox" checked> 경고 문구 표시</label>
        <div id="incomingWarnText" class="shareWarnText">
          ⚠️ 이 링크에는 배치도 정보가 포함됩니다. 실명/개인정보가 들어 있다면 적용 전에 확인하세요.
        </div>
        <div id="incomingSharePreview" class="sharePreview"></div>
      </div>
      <div class="modalFoot">
        <button id="incomingApplyBtn">적용</button>
        <button class="ghost" data-close="incomingShareModal">닫기</button>
      </div>
    </div>
  </div>

  <!-- ✅ 모둠 드롭다운(잘림 방지용) : 화면 위 레이어 -->
  <div id="groupMenu" class="groupMenu hidden" role="listbox" aria-label="모둠 번호 선택"></div>

  <script src="./app.js?v=0.84"></script>

<footer style="text-align:center; margin:20px 0; font-size:0.9em; color:rgba(255,255,255,0.85);">
  <a href="privacy.html" style="color:rgba(255,255,255,0.85);">개인정보처리방침</a> |
  <a href="terms.html" style="color:rgba(255,255,255,0.85);">이용약관</a> |
  <a href="about.html" style="color:rgba(255,255,255,0.85);">서비스 소개</a>
</footer>
</body>
</html>
